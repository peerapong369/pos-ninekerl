{% extends "base.html" %}

{% block title %}บอร์ดออเดอร์ก๋วยเตี๋ยว - ครัว{% endblock %}

{% block content %}
<section class="panel">
    <div class="panel-header">
      <h2>บอร์ดออเดอร์ก๋วยเตี๋ยว</h2>
      <div class="panel-header-actions">
        <button class="button button-outline" id="soundToggle">ปิดเสียง</button>
        <button class="button button-outline" id="fontDown">A-</button>
        <button class="button button-outline" id="fontUp">A+</button>
        <a class="button" href="{{ url_for('main.kitchen_dashboard') }}">กลับหน้าแสดงผลหน้าหลัก</a>
      </div>
    </div>
  {% if not orders %}
  <p>ยังไม่มีออเดอร์ก๋วยเตี๋ยวในขณะนี้</p>
  {% else %}
  <div class="table-wrapper">
    <table class="data-table kitchen-orders" id="ordersTable">
      <thead>
        <tr>
          <th>#</th>
          <th>โต๊ะ</th>
          <th>สถานะ</th>
          <th>เมนู</th>
          <th>ประเภทเส้น</th>
          <th>พิเศษ / เพิ่ม</th>
          <th>รายละเอียดอื่น</th>
          <th>เวลาสั่ง</th>
        </tr>
      </thead>
      <tbody id="ordersBody">
        {% for order, items in orders %}
        {% set is_served = order.status == 'completed' %}
        <tr class="{{ 'row-served' if is_served else '' }}">
          <td>#{{ order.id }}</td>
          <td>{{ order.table.name if order.table else '-' }}</td>
          <td>
            <span class="status-label status-{{ order.status }}">{{ status_labels.get(order.status, order.status) }}</span>
          </td>
          <td>
            <ul class="compact-list">
              {% for item in items %}
              <li>{{ item.quantity }} x {{ item.name }}</li>
              {% endfor %}
            </ul>
          </td>
          <td>
            <ul class="compact-list">
              {% for item in items %}
              {% if item.noodle %}
              <li>{{ item.noodle }}</li>
              {% else %}
              <li>-</li>
              {% endif %}
              {% endfor %}
            </ul>
          </td>
          <td>
            <ul class="compact-list">
              {% for item in items %}
              {% if item.extras %}
              <li>{{ item.extras }}</li>
              {% else %}
              <li>-</li>
              {% endif %}
              {% endfor %}
            </ul>
          </td>
          <td>
            <ul class="compact-list">
              {% for item in items %}
              <li>{{ item.other or '-' }}</li>
              {% endfor %}
            </ul>
          </td>
          <td>{{ order.created_at.strftime("%H:%M") }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
</section>
{% endblock %}

{% block scripts %}
<script>
  (function() {
    const table = document.getElementById("ordersTable");
    const soundToggle = document.getElementById("soundToggle");
    const down = document.getElementById("fontDown");
    const up = document.getElementById("fontUp");
    let size = 1;
    let soundEnabled = true;
    function refresh() {
      if (table) {
        table.style.fontSize = `${size}rem`;
      }
    }
    if (down) {
      down.addEventListener("click", () => {
        size = Math.max(0.8, size - 0.1);
        refresh();
      });
    }
    if (up) {
      up.addEventListener("click", () => {
        size = Math.min(1.5, size + 0.1);
        refresh();
      });
    }
    refresh();

    const body = document.getElementById("ordersBody");
    const seenOrders = new Map();
    let initialized = false;

    function updateSoundToggleLabel() {
      if (!soundToggle) return;
      soundToggle.textContent = soundEnabled ? "ปิดเสียง" : "เปิดเสียง";
      soundToggle.setAttribute("aria-pressed", soundEnabled ? "true" : "false");
    }

    if (soundToggle) {
      soundToggle.addEventListener("click", () => {
        soundEnabled = !soundEnabled;
        updateSoundToggleLabel();
      });
      updateSoundToggleLabel();
    }

    function handleOrdersPayload(orders) {
      if (!Array.isArray(orders)) {
        return;
      }
      if (!initialized) {
        orders.forEach((entry) => seenOrders.set(entry.id, true));
        initialized = true;
      } else {
        syncNewOrders(orders);
      }
      renderOrders(orders);
    }

    function syncNewOrders(orders) {
      const activeIds = new Set();
      orders.forEach((entry) => {
        activeIds.add(entry.id);
        if (!seenOrders.has(entry.id)) {
          seenOrders.set(entry.id, true);
          speakOrder(entry);
        }
      });
      Array.from(seenOrders.keys()).forEach((id) => {
        if (!activeIds.has(id)) {
          seenOrders.delete(id);
        }
      });
    }

    async function speakOrder(entry) {
      if (!soundEnabled) {
        return;
      }
      const items = (entry.items || []).map((item) => {
        const parts = [`${item.quantity} ${item.name}`];
        if (item.noodle) {
          parts.push(`เส้น ${item.noodle}`);
        }
        parts.push(item.extras ? item.extras : "ธรรมดา");
        if (item.other) {
          parts.push(item.other);
        }
        return parts.join(", ");
      });
      const message = `ออเดอร์โต๊ะ ${entry.table} ${items.join(" | ")}`;
      try {
        const response = await fetch(`/api/tts?text=${encodeURIComponent(message)}`);
        if (!response.ok) {
          throw new Error("tts");
        }
        const data = await response.json();
        if (data.audio) {
          const audio = new Audio(data.audio);
          audio.play();
          return;
        }
      } catch (error) {
        if (window.speechSynthesis) {
          const utterance = new SpeechSynthesisUtterance(message);
          utterance.lang = "th-TH";
          window.speechSynthesis.speak(utterance);
        }
      }
    }

    function renderOrders(orders) {
      if (!body) {
        return;
      }
      if (!orders.length) {
        body.innerHTML = '<tr><td colspan="8">ยังไม่มีออเดอร์ก๋วยเตี๋ยวในขณะนี้</td></tr>';
        return;
      }
      body.innerHTML = orders
        .map((entry) => {
          const itemRows = entry.items
            .map((item) => `<li>${item.quantity} x ${item.name}</li>`)
            .join("");
          const noodleRows = entry.items.map((item) => `<li>${item.noodle || "-"}</li>`).join("");
          const extrasRows = entry.items.map((item) => `<li>${item.extras || "-"}</li>`).join("");
          const otherRows = entry.items.map((item) => `<li>${item.other || "-"}</li>`).join("");
          const served = entry.status === "completed" ? "row-served" : "";
          const created = new Date(entry.created_at).toLocaleTimeString("th-TH", { hour: "2-digit", minute: "2-digit" });
          return `
            <tr class="${served}">
              <td>#${entry.id}</td>
              <td>${entry.table}</td>
              <td><span class="status-label status-${entry.status}">${entry.status_label || entry.status}</span></td>
              <td><ul class="compact-list">${itemRows}</ul></td>
              <td><ul class="compact-list">${noodleRows}</ul></td>
              <td><ul class="compact-list">${extrasRows}</ul></td>
              <td><ul class="compact-list">${otherRows}</ul></td>
              <td>${created}</td>
            </tr>
          `;
        })
        .join("");
    }

    function startStream(retryDelay = 0) {
      if (!("EventSource" in window)) {
        fetchFallback();
        return;
      }
      setTimeout(() => {
        const source = new EventSource("/api/kitchen/noodle-stream");
        window.__noodleStream = source;
        source.onmessage = (event) => {
          try {
            const payload = JSON.parse(event.data);
            handleOrdersPayload(payload.orders || []);
          } catch (error) {
            console.error("stream parse failed", error);
          }
        };
        source.addEventListener("ping", () => {});
        source.onerror = () => {
          source.close();
          setTimeout(() => startStream(2000), 2000);
        };
      }, retryDelay);
    }

    function fetchFallback() {
      fetch("/api/kitchen/noodle-orders")
        .then((response) => response.json())
        .then((data) => {
          handleOrdersPayload(data.orders || []);
          setTimeout(fetchFallback, 5000);
        })
        .catch(() => setTimeout(fetchFallback, 5000));
    }

    startStream();
  })();
</script>
{% endblock %}
