{% extends "base.html" %}

{% block title %}บอร์ดออเดอร์ก๋วยเตี๋ยว - ครัว{% endblock %}

{% block content %}
<section class="panel">
  <div class="panel-header">
    <h2>บอร์ดออเดอร์ก๋วยเตี๋ยว</h2>
    <div class="panel-header-actions">
      <button class="button button-outline" id="fontDown">A-</button>
      <button class="button button-outline" id="fontUp">A+</button>
      <a class="button" href="{{ url_for('main.kitchen_dashboard') }}">กลับหน้าแสดงผลหน้าหลัก</a>
    </div>
  </div>
  {% if not orders %}
  <p>ยังไม่มีออเดอร์ก๋วยเตี๋ยวในขณะนี้</p>
  {% else %}
  <div class="table-wrapper">
    <table class="data-table kitchen-orders" id="ordersTable">
      <thead>
        <tr>
          <th>#</th>
          <th>โต๊ะ</th>
          <th>สถานะ</th>
          <th>เมนู</th>
          <th>ประเภทเส้น</th>
          <th>พิเศษ / เพิ่ม</th>
          <th>รายละเอียดอื่น</th>
          <th>เวลาสั่ง</th>
        </tr>
      </thead>
      <tbody id="ordersBody">
        {% for order, items in orders %}
        {% set is_served = order.status == 'completed' %}
        <tr class="{{ 'row-served' if is_served else '' }}">
          <td>#{{ order.id }}</td>
          <td>{{ order.table.name if order.table else '-' }}</td>
          <td>
            <span class="status-label status-{{ order.status }}">{{ status_labels.get(order.status, order.status) }}</span>
          </td>
          <td>
            <ul class="compact-list">
              {% for item in items %}
              <li>{{ item.quantity }} x {{ item.name }}</li>
              {% endfor %}
            </ul>
          </td>
          <td>
            <ul class="compact-list">
              {% for item in items %}
              {% if item.noodle %}
              <li>{{ item.noodle }}</li>
              {% else %}
              <li>-</li>
              {% endif %}
              {% endfor %}
            </ul>
          </td>
          <td>
            <ul class="compact-list">
              {% for item in items %}
              {% if item.extras %}
              <li>{{ item.extras }}</li>
              {% else %}
              <li>-</li>
              {% endif %}
              {% endfor %}
            </ul>
          </td>
          <td>
            <ul class="compact-list">
              {% for item in items %}
              <li>{{ item.other or '-' }}</li>
              {% endfor %}
            </ul>
          </td>
          <td>{{ order.created_at.strftime("%H:%M") }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
</section>
{% endblock %}

{% block scripts %}
<script>
  (function() {
    const table = document.getElementById("ordersTable");
    const down = document.getElementById("fontDown");
    const up = document.getElementById("fontUp");
    let size = 1;
    function refresh() {
      if (table) {
        table.style.fontSize = `${size}rem`;
      }
    }
    if (down) {
      down.addEventListener("click", () => {
        size = Math.max(0.8, size - 0.1);
        refresh();
      });
    }
    if (up) {
      up.addEventListener("click", () => {
        size = Math.min(1.5, size + 0.1);
        refresh();
      });
    }
    refresh();

    const body = document.getElementById("ordersBody");
    async function fetchOrders() {
      try {
        const response = await fetch("/api/kitchen/noodle-orders");
        if (!response.ok) {
          return;
        }
        const data = await response.json();
        renderOrders(data.orders || []);
      } catch (error) {
        console.error(error);
      }
    }

    function renderOrders(orders) {
      if (!body) {
        return;
      }
      if (!orders.length) {
        body.innerHTML = '<tr><td colspan="8">ยังไม่มีออเดอร์ก๋วยเตี๋ยวในขณะนี้</td></tr>';
        return;
      }
      body.innerHTML = orders
        .map((entry) => {
          const itemRows = entry.items
            .map((item) => `<li>${item.quantity} x ${item.name}</li>`)
            .join("");
          const noodleRows = entry.items.map((item) => `<li>${item.noodle || "-"}</li>`).join("");
          const extrasRows = entry.items.map((item) => `<li>${item.extras || "-"}</li>`).join("");
          const otherRows = entry.items.map((item) => `<li>${item.other || "-"}</li>`).join("");
          const served = entry.status === "completed" ? "row-served" : "";
          const created = new Date(entry.created_at).toLocaleTimeString("th-TH", { hour: "2-digit", minute: "2-digit" });
          return `
            <tr class="${served}">
              <td>#${entry.id}</td>
              <td>${entry.table}</td>
              <td><span class="status-label status-${entry.status}">${entry.status_label || entry.status}</span></td>
              <td><ul class="compact-list">${itemRows}</ul></td>
              <td><ul class="compact-list">${noodleRows}</ul></td>
              <td><ul class="compact-list">${extrasRows}</ul></td>
              <td><ul class="compact-list">${otherRows}</ul></td>
              <td>${created}</td>
            </tr>
          `;
        })
        .join("");
    }

    fetchOrders();
    setInterval(fetchOrders, 5000);
  })();
</script>
{% endblock %}
